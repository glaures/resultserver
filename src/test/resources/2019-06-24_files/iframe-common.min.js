(function (document, window) {
    let clickTrackingUrl; let clickUrl; let nativeWindowOpen;

    let lastClick = 0;
    function windowOpen(url, name, features) {
        let now = new Date().getTime();
        let preventClick = now - lastClick < 500;
        lastClick = now;
        if (preventClick) {
            return;
        }

        let finalClickUrl = clickTrackingUrl + encodeURIComponent(url);
        nativeWindowOpen.call(window, finalClickUrl, name, features);
    }

    function getQueryParam(paramName) {
        let queryString; let paramsList; let paramValue; let i;

        queryString = window.location.search;
        queryString = queryString.substr(queryString.indexOf('?') + 1);
        paramsList = queryString.split('&');

        for (i = 0; i < paramsList.length; i++) {
            paramValue = paramsList[i].split('=');
            if (paramValue[0] === paramName) {
                return decodeURIComponent(paramValue[1]);
            }
        }

        return null;
    }


    function handleClickInsideBody(event) {
        let target = event.target;
        let href = target.href;
        while (target && !href) {
            target = target.parentElement;
            href = target && target.href;
        }
        if ((!href && !clickUrl) ||
            (href && href.match(/^(javascript:|null|undefined)/))) {
            return;
        }
        windowOpen(clickUrl || href);
        event.preventDefault();
    }

    function interceptCallsToWindowOpenFunction() {
        nativeWindowOpen = window.open;
        window.open = function (url, name, features) {
            windowOpen(clickUrl || url, name, features);
        };
    }

    function interceptClicksOnAnyElement() {
        document.addEventListener('DOMContentLoaded', function (event) {
            document.body.addEventListener('click', handleClickInsideBody);
            document.body.style.cursor = 'pointer';
        });
    }

    clickTrackingUrl = getQueryParam('clickTrackingUrl');
    clickUrl = getQueryParam('clickUrl');
    interceptCallsToWindowOpenFunction();
    interceptClicksOnAnyElement();
})(document, window);
